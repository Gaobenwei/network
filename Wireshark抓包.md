# Wireshark抓包

只抓包头

## 使用抓包过滤。

ARP是一个特殊的协议，而ARP当中的回复报文又是特殊当中的特殊，它的特殊体现在什么地方呢？ARP的回复报文不会像ARP请求报文那样，预先判断对方是否和自己是一个网段，而是会直接进行回复；据我所知，除了ARP的回复报文不会判断对方的IP地址是否和自己一个网段，其它正常的协议无论是请求还是回复都会都判断的



## 正常模式：

目标MAC地址明确（二层）是对应的网卡以及广播（二层）

## 混杂模式：

对应的网卡收到的所有数据帧。

抓包标记：可以在操作之前ping1个包，利用一组ICMP请求机返回包确定操作涉及的包的范围。

## 常用过滤

ip.addr ==192.168.2.3  == ip.src==192.168.2.3 || ip.dst==192.168.2.3

eth.addr==  ;eth.src ;eth.dst==;

tcp的源端口号、目的端口号过滤；

http的状态码

各层协议的字段判断

## 追踪流

wireshark以一定的规则追踪数据包

例如根据源IP 、目标IP；源端口、 目标端口生成一条规则，追踪满足的Telnet协议包

在依赖性协议中由于只能追踪一条规则，有一定局限。

## ARP技巧

在同一个网络域中与服务器连接时，服务器如果有自己的IP的值，客户机可以收到一些ARP广播报文，从而得知服务器的IP地址；

如果服务器使用DHCP自动获取IP地址，通过在客户机创建DHCP池得知服务器IP地址。

IP地址不是配置在网口位置，是在物理机的内核身上。

[16.一个容易出错的小幻觉（2022-01-15晚）_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1aA411Z7U9/?p=17&vd_source=db67eaaeba1abbe3e57066bb0e7f921c)

## 性能问题三板斧

统计概况  统计：服务响应时间  分析：专家信息。

## 判断在线

查看ARP缓存，例如Windows防火墙阻止不了ARP的广播请求及回复

## NFS网络文件系统 协议讲解

第0步：三次握手，探测服务端的111端口是否打开；

第一步：客户端向服务端的portmap进程询问NFS端口号，服务端告诉了。（TCP）

第二步：客户端探测一下2049是否通畅，服务端表示2049端口已打开；

第三部：客户端向服务端询问mount进程端口，服务端表示是eg：20048；

第四部：客户端探测20048是否通畅，服务端表示通畅；

第五步：重复第四步，没有必要；

第六步：MNT(MOUNT)客户端要求挂载/code目录；服务端表示OK，并告知客户端以后用一个名字指代/code目录。

第七步：重复一、二步；

第八步：客户端会通过多个call获取服务端目录的属性信息。

portmap、nfs端口一般固定；mount 不固定；期要注意服务器防火墙。

### 访问控制

NFS对客户端的访问控制通过IP地址实现，注意有可能客户端的IP被NAT转换而导致挂载失败；

### 权限

NFS用户权限若不同的客户端设置各异，可能出现同一属性不同解读的情形；

### NFS读写分析

读写分析注意写入用户的不同权限，在配置文件中可以设置查看。

询问目录句柄值；

客户端请求进去文件；客户端回应允许；

客户端询问目标目录下有无某文件；服务端回应；

客户端发送创建的系统调用；服务端允许；

客户端设置权限，服务端会帮客户设置权限；

客户端连续写入，服务端连续回复，客户端询问是否写入了磁盘，服务端会有个提交操作确认写入。可以通过参数sync，要求立刻写入，即一个写，一个确认。

## 关于wireshark工作位置

链路层工作内容：封装成帧、透明传输、差错检测

封装：帧头+源目MAC+类型+数据+差错检测+帧尾

​			源目MAC

​			上层协议类型

​			wireshark在此工作（抓包NFS的链路层帧只有上面两项）

​            校验和

解封装：拆除校验和、（wireshark在此工作）2拆除类型、3拆除MAC地址

内核中的TCP/IP协议栈当中，通信子网（传输层、网络层、链路层），网卡完成校验和附加与拆除

了解作用：分析受损数据帧、wireshark只是在特定位置记录帧

## 链路层分片

MSS(三次握手的时候设置，是个可选字段，TCP载荷)+TCP头部+IP头部=MTU

MSS：1460

20+20+18（tcp+ip+链路层头）共1518字节

eg:整体的报文：60000+

传输层封装：mss=1460，例如无分片，60000+

网络层：ip头部；

链路层：1.源目MAC

​				2.上层协议类型

​				wireshark

​				分片

​				3.校验和

链路层解封装：拆除校验和

结合成一个

wireshark

拆除类型

拆除MAC地址

wireshark抓到的报文没有分片，只有网卡发出去时才是分片的。在客户端或服务端主机抓包时，是在分片前or合并后，可以通过关闭网卡分片功能，让传输层分片，抓到的就是在1518字节内的。

### 假设在网络路径上存在一个MTU小于1500的设备（eg:MTU=1400的路由器）

1.通过路由器向服务端发送数据，根据三次握手的MSS值，1500

2.到达路由器之后，路由器发现自己的MTU是1400，客户端是1500

2.1客户端已经给服务端发送了很多数据：1500的；可以判断这些数据的抓包分析经路由器转发是否丢包。

2.2路由器发现MTU与自己不一样丢掉。

3.路由器会根据ICMP报文告知客户端：路由器自己的MTU是1400，意思是让客户端发送MTU是1400的报文，不要超过1400

4.客户端听劝，所以NFS_write call用的MTU是1400

之后卸载掉重新挂载（NFS过程），由于缓存了MTU

所以mount过程中TCP_mss：1400-40=1360.

## TCP端口字段

### 端口冲突

端口冲突会导致后启动当的程序无法启动

### 为什么会吧SSH端口改大一些

为了隐藏自己的SSH端口号，熟知的nmap扫描端口号常扫描：0--1024+熟知端口号。

### 如果没有应用侦听哪个套接字，强行连接目的端会直接在建立连接阶段返回拒绝。

## TCP Reset字段

### Reset报文作用

### 什么场景下会发送Reset报文

1.SSH版本不支持下，例如客户端用SSH1去连接服务端SSH2

服务端会告诉客户端自己的SSH版本，客户端应用进程告诉内核自己不支持这版本，你发送一个Reset报文。

2.BGP egR1与R2，BGP在路由器中作为进程侦听端口号，且会严格限制源IP地址。

如果源IP地址不是自己规定的，TCP连接过程也会发送Reset

3.程序崩溃

会发送Reset，会请求断开连接

4.非法报文

客户端向服务端发送非法报文，服务端返回Reset字段。可以优化，eg:提前判断包有问题，直接丢，不回复等

5.端口未侦听

### Reset报文是谁发送的？应用进程or内核

内核发送的

## TCP窗口

TCP头部中的window size是向接收方声明自己的接收窗口是多大，发送端就会限制发送窗口。

发送窗口决定了一次性可以发送多少字节，而MSS决定了这些字节要多少个包才能发完。

## 重传的讲究

### 慢启动到达临界窗口值，然后拥塞避免上升；

**发生拥塞后，就是发送出去的包得不到及时的确认，发送方等待一段时间时间后，重传，叫做超时重传，时间间隔RTO，在RTO这段等待时间内没有传送数据**，而在轻微的拥塞或者数据包少量丢失的情况下，是会收到确认包的，只是确认号提示没有收到某些包，**收到重复确认意识到保丢失**，就会重传，**这是快速回复，因为不像超时重传一样需要等待一段时间。**

### 而在拥塞避免阶段发生快速重传，不用等待RTO，**直接进行快速恢复阶段**，

多个包丢失的情况有各种处理方案，例如：2,3号包丢失，重传2之后。发送ACK=3，再重传3

例如：在收到ACK=2之后，顺便吧收到的包告诉发送方，eg：收到4号包时，告诉发送方；：收到了4号包，ack=2

**丢包小文件影响更严重，因为文件小，凑不到多个重复确认，**只能等待超时重传。

## 延迟确认与Nagle算法

如果收到一个包之后暂时没有数据要发送给对方，延迟一段时间再确认，假如这段时间有数据要发送，确认信息和数据一起发送。

在发送的数据还没有被确认之前，假如又有小数据生成，就把小数据收集起来，凑满一个MSS或等收到确认后在发送。

## UDP

UDP不想TCP一样在乎双方MTU的大小，他将应用层数据加上UDP头部直接交给下一层，分片的工作是IP层完成

UDP没有重传机制

UDP没有重传机制

分片机制有缺点，通过More fragments的flag判断后续还有没有片。

## CIFS

微软的文件共享协议。

只能基于TCP协议，CIFS服务器上的端口号是445。**首先建立TCP连接；**

第一个CIFS操作：**协商**，客户端将自己支持的CIFS版本发给服务端，服务端选择支持的回复客户端；

**建立CIFS Session Setup**，任务身份验证，之后意味着已经打开了服务器

**Tree Connect**,打开共享，返回Tree ID用于客户端访问共享的子目录和子文件；这一步并不检查权限，一个TCP连接可以维持多个打开的Tree Connect

**Create 创建请求**无论新建文件、打开目录、读写文件都会需要Create

常见问题：

## DNS

解析域名到IP地址；一些记录的类型：

PTR记录：从IP地址解析到域名；

SRV记录：域里的资源；

CNAME记录：别名。eg:服务器10.32.106.73同时提供网页（WWW）、邮件（mail）、地图（map）服务。在DNS中的配置可以是：www的记录指向10.32.106.73；mail和map这两个记录指向www。客户端访问这三个域名都会映射到10.32.106.73上。

DNS工作方式有递归查询和迭代查询。

## FTP

建立连接之前客户端发起三次握手的TCP连接，

ftp使用明文传输，包括密码；

下载过程：客户端：相连接，服务器：同意；

客户端：想下载文件；服务器：给你上传，

**之后建立TCP连接（这一步建立连接者分两类，主动模式，服务器主动建立连接，被动模式：客户端建立连接），然后服务器传输文件，在断开连接。由此可见，ftp的控制连接，与数据连接是分开的，端口号使用也不同，客户端的不变，**

## Kerberos（复杂，未彻底明白）

一个身份认证协议，认证结果是双向的，账号A访问资源B时，不但B要确保A不是冒充，A也要确保B不是假的。

Kerbeors采用引入权威的第三方负责身份认证，第三方称为KDC

第一步：账号A和KDC互相认证；

第二步：账号A请KDC帮忙认证资源B；

第三步：账号A和资源B互相认证。
